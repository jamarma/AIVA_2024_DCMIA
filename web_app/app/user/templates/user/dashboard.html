{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-lg-4 rounded-4 shadow bg-white">
        <h2 class="fw-bold text-center pt-3 pb-1 mx-3">Análisis de imagen</h2>

        <div id="imageUploadForm" class="row mt-3 mx-2">
            <div class="col">
                <div id="imagePreview" class="text-center"></div>
                <div id="progressBarContainer" class="progress mt-3" style="display: none;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div id="uploadButtonContainer" class="mt-3">
                    <input id="imageInput" type="file" class="form-control">
                    <button id="uploadButton" class="btn btn-primary mt-2">Cargar</button>
                </div>
                <div id="warningMessage" class="mt-2" style="display: none;">
                    <p style="color: red;">Por favor, selecciona una imagen para cargar.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('uploadButton').addEventListener('click', function() {
        var fileInput = document.getElementById('imageInput');
        var file = fileInput.files[0];
        if (!file) {
            // Si no se selecciona ningún archivo, mostrar el mensaje de advertencia y salir de la función
            document.getElementById('warningMessage').style.display = 'block';
            return;
        }

        var formData = new FormData();
        formData.append('image', file);

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload', true);

        xhr.upload.addEventListener('progress', function(event) {
            var progressBar = document.getElementById('progressBar');
            var percent = (event.loaded / event.total) * 100;
            progressBar.style.width = percent + '%';
            progressBar.setAttribute('aria-valuenow', percent);
        });

        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                // Procesar la respuesta del servidor si es necesario
                // Aquí puedes mostrar la imagen cargada en #imagePreview

                // Redirigir a la página de resultados
                window.location.href = "/resultados";
            }
        };

        xhr.send(formData);

        // Ocultar el botón y mostrar la barra de progreso
        document.getElementById('uploadButtonContainer').style.display = 'none';
        document.getElementById('progressBarContainer').style.display = 'block';
    });
</script>
{% endblock %}
