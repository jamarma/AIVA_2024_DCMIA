{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-lg-4 rounded-4 shadow bg-white" style="margin-top: 2rem;">
        <h2 id="titleLabel" class="fw-bold text-center pt-3 pb-1 mx-3" style="margin-bottom: 2rem;">Análisis de imagen</h2>

        <div id="imageUploadForm" class="row mt-3 mx-2">
            <div class="col">
                <div id="imagePreview" class="text-center"></div>
                <div id="processingContainer" class="mt-3 text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Procesando...</span>
                    </div>
                    <p class="mt-2">Procesando... Esto puede tardar unos minutos.</p>
                </div>
                <div id="uploadButtonContainer" class="mt-3">
                    <input id="imageInput" type="file" class="form-control mb-2">
                </div>
                <div id="processButtonContainer" class="text-center mb-2">
                    <button id="uploadButton" class="btn btn-primary mt-2">Procesar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('uploadButton').addEventListener('click', function() {
        var fileInput = document.getElementById('imageInput');
        var file = fileInput.files[0];
        if (!file) {
            // Si no se selecciona ningún archivo, salir de la función
            return;
        }

        var formData = new FormData();
        formData.append('image', file);

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload', true);

        xhr.upload.addEventListener('progress', function(event) {
            // No necesitas hacer nada aquí porque ya no estás utilizando la barra de progreso
        });

        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                // Procesar la respuesta del servidor si es necesario
                // Aquí puedes mostrar la imagen cargada en #imagePreview

                // Redirigir a la página de resultados
                window.location.href = "/resultados";
            }
        };

        xhr.send(formData);

        // Ocultar el botón y mostrar el mensaje de procesamiento
        document.getElementById('uploadButtonContainer').style.display = 'none';
        document.getElementById('processButtonContainer').style.display = 'none';
        document.getElementById('processingContainer').style.display = 'block';

        // Cambiar el título a "Analizando imagen"
        document.getElementById('titleLabel').innerText = "Analizando imagen";
    });
</script>
{% endblock %}
